<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prism Viewer</title>
  <style>
    html,body { height:100%; margin:0; background:#000; }
    #newsFrame { width:100%; height:100%; border:0; display:block; }
    #overlay {
      position:fixed; right:8px; top:8px; z-index:9999;
      background:rgba(0,0,0,0.6); color:#fff; padding:6px 8px; border-radius:6px; font-size:13px;
    }
  </style>
</head>
<body>
  <div id="overlay">ìƒíƒœ: <span id="status">ì—°ê²°ì¤‘...</span></div>
  <iframe id="newsFrame" src="/proxy?url=https://news.naver.com/" allow="autoplay"></iframe>

  <script>
    const SERVER = location.origin;
    const params = new URLSearchParams(location.search);
    const room = params.get('room') || 'default';

    const statusEl = document.getElementById('status');
    const iframe = document.getElementById('newsFrame');

    // WebSocket
    const wsProto = (location.protocol === 'https:') ? 'wss:' : 'ws:';
    const wsUrl = `${wsProto}//${location.host}/?type=viewer&room=${encodeURIComponent(room)}`;
    const ws = new WebSocket(wsUrl);

    ws.onopen  = () => statusEl.textContent = 'ì—°ê²°ë¨';
    ws.onclose = () => statusEl.textContent = 'ì—°ê²° ëŠê¹€';
    ws.onerror = () => statusEl.textContent = 'ì˜¤ë¥˜';

    function safeExec(fn) {
      try {
        const win = iframe.contentWindow;
        if (!win) return;
        fn(win);
      } catch (e) {
        console.warn('safeExec failed', e);
      }
    }

    // ğŸ”¹ iframe load ì‹œ í•­ìƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
    function attachIframeHandlers() {
      safeExec(win => {
        const doc = win.document;

        // ëª¨ë“  <a> í´ë¦­ ê°•ì œ proxy
        doc.addEventListener("click", e => {
          const a = e.target.closest("a");
          if (!a) return;

          const href = a.getAttribute("href");
          if (!href) return;

          e.preventDefault();
          const url = new URL(href, win.location.href).href;
          iframe.src = `/proxy?url=${encodeURIComponent(url)}`;
        });

        // window.location ê°€ë¡œì±„ê¸°
        const loc = win.location;
        const origAssign = loc.assign.bind(loc);
        loc.assign = u => { iframe.src = `/proxy?url=${encodeURIComponent(new URL(u, loc.href).href)}`; };
        const origReplace = loc.replace.bind(loc);
        loc.replace = u => { iframe.src = `/proxy?url=${encodeURIComponent(new URL(u, loc.href).href)}`; };
        Object.defineProperty(loc, "href", {
          set(u) { iframe.src = `/proxy?url=${encodeURIComponent(new URL(u, loc.href).href)}`; }
        });
      });
    }

    iframe.addEventListener("load", attachIframeHandlers);

    // ğŸ”¹ WebSocket ëª…ë ¹ ì²˜ë¦¬
    ws.onmessage = ev => {
      const msg = ev.data;

      try {
        const obj = JSON.parse(msg);
        if (obj.cmd === 'goto') {
          iframe.src = `/proxy?url=${encodeURIComponent(obj.url)}`;
          return;
        }
      } catch(e){}

      if (msg === "scrollDown") safeExec(win => win.scrollBy(0,400));
      else if (msg === "scrollUp") safeExec(win => win.scrollBy(0,-400));
      else if (msg.startsWith("go:")) {
        const url = msg.slice(3);
        iframe.src = `/proxy?url=${encodeURIComponent(url)}`;
      }
      else if (msg.startsWith("eval:")) safeExec(win => { try { win.eval(msg.slice(5)); } catch(e){} });
      else if (msg.startsWith("click:")) safeExec(win => {
        const el = win.document.querySelector(msg.slice(6));
        if(el) el.click();
      });
      else safeExec(win => { try { win.eval(msg); } catch(e){} });
    };
  </script>
</body>
</html>
